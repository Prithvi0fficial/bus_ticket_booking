{% load static %}
{% load crispy_forms_tags %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    
<style>
  /* Seat Selection Container */
  .seat-selection-container {
    max-width: 500px;
    margin: 40px auto;
    padding: 30px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    text-align: center;
    font-family: 'Segoe UI', sans-serif;
  }

  /* Heading */
  .seat-selection-container h2 {
    font-size: 24px;
    margin-bottom: 10px;
  }

  .driver-label {
    display: inline-block;
    background-color: #333;
    color: white;
    padding: 5px 15px;
    border-radius: 8px;
    margin: 15px 0;
    font-size: 14px;
  }

  /* Seat Styles */
  .seat-wrapper {
    position: relative;
    width: 50px;
    height: 70px;
    cursor: pointer;
    display: inline-block;
    transition: transform 0.2s ease;
  }

  .seat-wrapper input {
    display: none;
  }

  .seat-inner {
    width: 100%;
    height: 100%;
    background-color: #4CAF50;
    /* Available */
    border-radius: 10px 10px 5px 5px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
    padding-bottom: 5px;
  }

  .seat-head {
    height: 15px;
    width: 100%;
    background-color: #2e7d32;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
  }

  .seat-body {
    flex-grow: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .seat-label {
    color: white;
    font-weight: bold;
    font-size: 14px;
  }

  .seat-wrapper:hover:not(.booked) .seat-inner {
    transform: scale(1.05);
  }

  /* Selected */
  .seat-wrapper input:checked+.seat-inner {
    background-color: #FFA500;
    box-shadow: 0 0 10px #FFA500aa;
  }

  /* Booked */
  .seat-wrapper.booked .seat-inner {

  color: white;
  cursor: not-allowed;
  box-shadow: none;
}


  /* Aisle */
  .aisle {
    width: 30px;
    height: 70px;
  }

  .seat-row {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 10px;
  }

  .seat-group {
    display: flex;
    gap: 10px;
  }

  /* Confirm Button */
  .confirm-btn {
    background-color: #007bff;
    color: white;
    padding: 10px 25px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    margin-top: 20px;
    cursor: pointer;
    transition: 0.3s ease;
  }

  .confirm-btn:hover {
    background-color: #0056b3;
  }

  /* Summary */
  .selection-summary {
    margin-top: 15px;
    font-size: 16px;
  }

  /* Legend */
  .legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
    font-size: 14px;
  }

  .legend div {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .legend-box {
    width: 20px;
    height: 20px;
    border-radius: 5px;
  }

  .available {
    background-color: #4CAF50;
  }

  .selected {
    background-color: #FFA500;
  }




  .message-container {
    margin-bottom: 20px;
  }

  .message {
    padding: 12px 20px;
    border-radius: 8px;
    margin: 10px auto;
    font-weight: 500;
    font-size: 15px;
    max-width: 400px;
    text-align: center;
  }

  .message.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  .message.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }
  /* Navbar Container */
nav {
  background: white;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  padding: 16px 0px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-radius: 12px;
  width: 100%; /* Full width */
  position: relative;
}

    /* Centered Navigation */
    .nav-center {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }

    .nav-links {
      list-style: none;
      display: flex;
      gap: 20px;
      margin: 0;
      padding: 0;
      flex-wrap: wrap;
    }

    .nav-links a {
      text-decoration: none;
      color: #444;
      font-weight: 600;
      transition: color 0.3s ease;
    }

    .nav-links a:hover {
      color: #1d4ed8;
    }

    /* Profile Dropdown */
    .profile-dropdown {
      position: relative;
    }

    .profile-info {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    .profile-info img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #ccc;
    }

    .profile-info span {
      font-weight: 500;
      color: #333;
    }

    /* Dropdown Menu */
    .dropdown-menu {
      display: none;
      position: absolute;
      top: 60px;
      right: 0;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      width: 150px;
      overflow: hidden;
      z-index: 100;
    }

    .dropdown-menu a {
      display: block;
      padding: 12px 16px;
      font-size: 16px;
      color: #000;
      text-decoration: none;
      transition: background 0.2s;
    }

    .dropdown-menu a:hover {
      background: #f0f0f0;
    }

    .dropdown-menu.show {
      display: block;
    }

    /* Responsive Styles */
    @media screen and (max-width: 768px) {
      nav {
        flex-direction: column;
        gap: 10px;
      }

      .nav-center {
        position: static;
        transform: none;
        order: -1;
      }

      .profile-info span {
        display: none;
      }

      .dropdown-menu {
        left: 0;
        right: auto;
      }
    }
    body::-webkit-scrollbar {
            display: none;
            /* Chrome, Safari, Opera */
        }
            /* Footer */
.footer {
    background: white;
    color: #333;
    text-align: center;
    padding: 20px;
    position: relative;
    font-size: 16px;
}

.footer .social-icons {
    margin-top: 10px;
}

.footer .social-icons a {
    color: #333;
    text-decoration: none;
    margin: 0 10px;
    font-size: 24px;
    transition: color 0.3s, transform 0.3s;
}

.footer .social-icons a:hover {
    color: #ffcc00;
    transform: scale(1.2);
}

.footer-links a {
    color: #333;
    margin: 0 15px;
    text-decoration: none;
    font-size: 16px;
    transition: 0.3s;
}

.footer-links a:hover {
    color: #888;
}
.seat-wrapper.booked .seat-inner{
  border: 2px solid red !important;
  pointer-events: none; /* Optional: prevents clicking */
  opacity: 0.5; /* Optional: faded out */
  background-color: red;
}

</style>
<nav>
  <div>
    <a href="{% url 'home' %}">
      <img src="{% static 'img/ngarage_logo.png' %}" alt="NGarage Logo" style="height: 50px; width: auto;">
    </a>
  </div>
  <!-- Placeholder for left space to balance center alignment -->
  <div></div>

  <!-- Center Navigation -->
  <div class="nav-center">
    <ul class="nav-links">
      <li><a href="{% url 'home' %}">Home</a></li>
      <a href="{% url 'search_buses' %}">Booking</a>
      <a href="{% url 'about' %}">About</a>
    </ul>
  </div>

  <!-- Profile Section -->
  <div class="profile-dropdown">
    <div class="profile-info" onclick="toggleDropdown()">
      {% if user_profile and user_profile.image %}
      <img src="{{ user_profile.image.url }}" alt="Profile" class="rounded-full w-10 h-10">
    {% else %}
      <img src="{% static 'images/default_profile.png' %}" alt="Default Profile" class="rounded-full w-10 h-10">
    {% endif %}
    
      <span>{{ request.user.first_name|default:request.user.username }}</span>
    </div>

    <div class="dropdown-menu" id="dropdownMenu">
      <a href="{% url 'user_dashboard' %}">Dashboard</a>
      <a href="{% url 'update_profile' %}">Profile</a>
      <a href="{% url 'user_logout' %}">Logout</a>
    </div>
  </div>
</nav>

{% if messages %}
<div class="message-container">
  {% for message in messages %}
  <div class="message {{ message.tags }}">{{ message }}</div>
  {% endfor %}
</div>
{% endif %}
<div class="seat-selection-container">
  <h2>Seat Selection</h2>
  <p><strong>{{ schedule.bus.name }}</strong></p>
  <p><strong>Route:</strong> {{ bus.route }}</p>
  <p>
    <strong>Departure:</strong> {{ schedule.departure_time|date:"d-M-Y" }} {{ schedule.departure_time|time:"h:i A" }}
  </p>

  <div class="driver-label">Driver</div>

  <form method="post">
    {% csrf_token %}
    {% for row in seat_layout %}
    <div class="seat-row">
      <div class="seat-group">
        {% for seat in row %}
        {% if seat == "aisle" %}
        <div class="aisle"></div>
        {% else %}
        <label class="seat-wrapper {% if seat in booked_seats %}booked{% endif %}" data-seat="{{ seat }}">
          <input type="checkbox" name="selected_seats" value="{{ seat }}" {% if seat in booked_seats %}disabled{% endif%}>
          <div class="seat-inner">
            <div class="seat-head"></div>
            <div class="seat-body">
              <span class="seat-label">{{ seat }}</span>
            </div>
          </div>
        </label>
        {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endfor %}

    <div class="selection-summary">
      Selected Seats: <strong id="selected-seats-display">None</strong><br>
      Total Seats: <strong id="total-seats-display">0</strong><br>
      Total Price: â‚¹<strong id="total-price-display">0</strong>
    </div>
    <button type="submit" class="confirm-btn">Confirm Selection</button>
  </form>

  <div class="legend">
    <div>
      <div class="legend-box available"></div> Available
    </div>
    <div>
      <div class="legend-box selected"></div> Selected
    </div>
    <div>
      <!--<div class="legend-box book"></div> Booked -->
    </div>
  </div>
</div>
<footer class="footer">
  <div class="social-icons">
            <a href="https://facebook.com" target="_blank"><i data-lucide="facebook"></i></a>
            <a href="https://twitter.com" target="_blank"><i data-lucide="twitter"></i></a>
            <a href="https://instagram.com" target="_blank"><i data-lucide="instagram"></i></a>
            <a href="https://linkedin.com" target="_blank"><i data-lucide="linkedin"></i></a>
  </div>
  <br>
  <div class="footer-links">
      <a href="{% url 'terms_and_conditions' %}">Privacy</a>
      <a href="{% url 'terms_and_conditions' %}">Terms</a>
      <a href="{% url 'feedback' %}" >Give Feedback</a>
  </div>
  <p>Â© 2025 NGarage. All Rights Reserved.</p>

</footer>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const seatCheckboxes = document.querySelectorAll('input[name="selected_seats"]');
    const seatDisplay = document.getElementById("selected-seats-display");
    const totalDisplay = document.getElementById("total-seats-display");
    const priceDisplay = document.getElementById("total-price-display");
    const pricePerSeat = parseFloat("{{ seat_price|floatformat:2 }}");

    seatCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const selected = Array.from(seatCheckboxes)
          .filter(cb => cb.checked)
          .map(cb => cb.value);

        const count = selected.length;
        seatDisplay.textContent = count > 0 ? selected.join(', ') : 'None';
        totalDisplay.textContent = count;
        priceDisplay.textContent = (count * pricePerSeat).toFixed(2);
      });
    });

    // ðŸ”’ Alert when clicking on booked seat (fix: attach to .seat-inner instead)
    const bookedSeatInners = document.querySelectorAll('.seat-wrapper.booked .seat-inner');

bookedSeatInners.forEach(seat => {

  // Prevent clicking and show alert
  seat.addEventListener('click', function (e) {
    e.preventDefault();
    alert("Sorry, this seat is already booked.");
  });
});
});
  document.querySelector('form').addEventListener('submit', function (event) {
    const selectedSeats = Array.from(seatCheckboxes)
      .filter(cb => cb.checked)
      .map(cb => cb.value);

    // Attach selected seats to the form before submitting
    const selectedSeatsInput = document.createElement('input');
    selectedSeatsInput.setAttribute('type', 'hidden');
    selectedSeatsInput.setAttribute('name', 'selected_seats');
    selectedSeatsInput.setAttribute('value', selectedSeats.join(','));

    this.appendChild(selectedSeatsInput);
  });


  function toggleDropdown() {
    document.getElementById("dropdownMenu").classList.toggle("show");
  }

  document.addEventListener('click', function (e) {
    const dropdown = document.getElementById('dropdownMenu');
    const profile = document.querySelector('.profile-info');
    if (!profile.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.classList.remove('show');
    }
  });
</script>

<script>
  // Function to update the unavailable seats section
  function updateUnavailableSeats() {
    const scheduleId = {{ schedule.id }};
    fetch(`/seat_selection/${scheduleId}/`)
      .then(response => response.json())
      .then(data => {
        const unavailableSeats = data.unavailable_seats;
        
        // Update the unavailable seats list in the UI
        const unavailableSeatsList = document.getElementById('unavailable-seats-list');
        unavailableSeatsList.innerHTML = ''; // Clear the current list

        unavailableSeats.forEach(seat => {
          const listItem = document.createElement('li');
          listItem.textContent = seat;  // Display seat number
          unavailableSeatsList.appendChild(listItem);
        });

        // Show the updated unavailable seats
        document.getElementById('unavailable-seats').style.display = 'block';
      })
      .catch(error => console.error('Error fetching unavailable seats:', error));
  }

  // Auto-refresh every 5 seconds (you can adjust the interval as needed)
  setInterval(updateUnavailableSeats, 5000);

  // Optionally, you can call this function on page load as well
  document.addEventListener('DOMContentLoaded', updateUnavailableSeats);
</script>